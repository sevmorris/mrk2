#!/usr/bin/env bash
set -euo pipefail

# mrk2 status — check installation status

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
readonly SCRIPT_DIR REPO_ROOT
readonly BREWFILE="$REPO_ROOT/Brewfile"

warn() { printf "[warn] %s\n" "$*" >&2; }

check_homebrew() {
  if command -v brew >/dev/null 2>&1; then
    echo "✓ Homebrew: $(brew --version | head -n1)"
    return 0
  else
    echo "✗ Homebrew: Not installed"
    return 1
  fi
}

check_brewfile() {
  if [[ ! -f "$BREWFILE" ]]; then
    echo "✗ Brewfile: Not found at $BREWFILE"
    return 1
  fi

  echo "✓ Brewfile: Found"

  # Count items in single pass
  local formulae=0 casks=0 taps=0
  while IFS= read -r line; do
    case "$line" in
      brew\ *) ((formulae++)) ;;
      cask\ *) ((casks++)) ;;
      tap\ *)  ((taps++)) ;;
    esac
  done < "$BREWFILE"

  echo "  - Formulae: $formulae"
  echo "  - Casks: $casks"
  (( taps > 0 )) && echo "  - Taps: $taps"
  return 0
}

check_installed_packages() {
  if ! command -v brew >/dev/null 2>&1; then
    warn "Homebrew not available, skipping package check"
    return 1
  fi

  echo ""
  echo "Installed packages from Brewfile:"

  # Pre-fetch installed package lists for O(1) lookup
  declare -A _installed_formulae=()
  declare -A _installed_casks=()
  while IFS= read -r _pkg; do
    [[ -n "$_pkg" ]] && _installed_formulae["$_pkg"]=1
  done < <(brew list --formula 2>/dev/null)
  while IFS= read -r _pkg; do
    [[ -n "$_pkg" ]] && _installed_casks["$_pkg"]=1
  done < <(brew list --cask 2>/dev/null)

  local installed=0 missing=0 total=0

  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue

    if [[ "$line" =~ ^brew\ \"([^\"]+)\" ]]; then
      local pkg="${BASH_REMATCH[1]}"
      ((total++))
      if [[ -n "${_installed_formulae[$pkg]+x}" ]]; then
        echo "  ✓ $pkg"
        ((installed++))
      else
        echo "  ✗ $pkg (not installed)"
        ((missing++))
      fi
    elif [[ "$line" =~ ^cask\ \"([^\"]+)\" ]]; then
      local cask="${BASH_REMATCH[1]}"
      ((total++))
      if [[ -n "${_installed_casks[$cask]+x}" ]]; then
        echo "  ✓ $cask (cask)"
        ((installed++))
      else
        echo "  ✗ $cask (cask, not installed)"
        ((missing++))
      fi
    fi
  done < "$BREWFILE"

  echo ""
  echo "Summary: $installed/$total installed, $missing missing"
}

main() {
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "  mrk2 Installation Status"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  check_homebrew
  check_brewfile

  command -v brew >/dev/null 2>&1 && check_installed_packages

  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

main
